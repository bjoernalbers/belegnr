#!/bin/sh
# belegnr â€” Generate sequential, unique document numbers (Belegnummern)

export PATH="/bin:/sbin:/usr/bin:/usr/sbin"

# File name of this script (without path).
script_name="${0##*/}"

# Each document number (Belegnummer) starts with this string.
prefix="BE-"

# The first number.
start=1000

# Default file to store the current number.
file="${HOME}/.belegnr"

# Which action to perform.
action=""

# Display usage information.
display_usage() {
cat <<EOM
Usage: ${script_name} [OPTIONS]

Options:
  -f  File to store the current number (default: ~/.belegnr)
  -h  Display usage and exit
  -n  Create new document number (Belegnummer)
EOM
}

# Abort script with an error message.
abort() {
	echo "${script_name}: $*" >&2
	exit 1
}

# Parse options.
while getopts 'f:hn' opt; do
	case "${opt}" in
		f)
			file="${OPTARG}"
			;;
		h)
			display_usage
			exit 0
			;;
		n)
			action="new"
			;;
		*)
			display_usage
			exit 1
			;;
	esac
done
shift $((OPTIND-1))

# Display help and exit if no action specified.
if [ -z "${action}" ]; then
       display_usage
       exit 0
fi

# Abort, if $HOME not set.
[ -n "${HOME}" ] || abort "variable HOME not defined or empty"

# If file exists, read, validate and increment number.
if [ -f "${file}" ]; then
	nr=$(cat "${file}") || abort "could not read file: ${file}"
	[ "${nr}" -ge 0 ] 2> /dev/null || abort "file contains no valid number: ${file}"
	nr=$((nr+1))
# Else start from scratch.
else
	nr="${start}"
fi

# Write current number atomically.
tmp=$(mktemp) || abort "failed to create temporary file"
if ! (echo "${nr}" > "${tmp}" && mv -f "${tmp}" "${file}"); then
       abort "could not write file: ${file}"
fi

# Output the formatted document number.
echo "${prefix}${nr}"
