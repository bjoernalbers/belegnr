#!/bin/sh
# belegnr - Erzeugt fortlaufende, l체ckenlose Belegnummern f체r deine Buchhaltung

export PATH="/bin:/sbin:/usr/bin:/usr/sbin"

# Basename of this script
script_name="${0##*/}"

# Jede Belegnummer beginnt mit dieser Zeichenkette.
prefix="BE-"

# Die Zahl, ab der fortlaufende Belegnummern erzeugt werden.
start=1000

# In dieser Datei wird die zuletzt erzeugte Belegnummer gespeichert.
file="${HOME}/.belegnr"

# Which action to perform.
action=""

# Display usage.
display_usage() {
cat <<EOM
Usage: ${script_name} [OPTIONS]

Options:
  -f  File to store latest Belegnummer (default: ~/.belegnr)
  -h  Display usage and exit
  -n  Create new Belegnummer
EOM
}

# Bricht das Skript mit gegebener Fehlermeldung ab.
abort() {
	echo "${script_name}: $*" >&2
	exit 1
}

# Process options.
while getopts 'f:hn' opt; do
	case "${opt}" in
		f)
			file="${OPTARG}"
			;;
		h)
			display_usage
			exit
			;;
		n)
			action="new"
			;;
		*)
			display_usage
			exit 1
			;;
	esac
done
shift $((OPTIND-1))

# Display help and exit if no action is defined.
if [ -z "${action}" ]; then
       display_usage
       exit
fi

# Abbruch, wenn $HOME nicht gesetzt ist.
[ -n "${HOME}" ] || abort "Variable HOME ist nicht definiert oder leer."

# If file exists, read and validate content, then increment number.
if [ -f "${file}" ]; then
	nr=$(cat "${file}") || abort "Datei ${file} konnte nicht gelesen werden."
	[ "${nr}" -ge 0 ] 2> /dev/null || abort "Datei ${file} enth채lt keine g체ltige Belegnummer."
	nr=$((nr+1))
# Else use start number.
else
	nr="${start}"
fi

# Write current number to file.
tmp=$(mktemp)
echo "${nr}" > "${tmp}" && mv "${tmp}" "${file}" || abort "${file} konnte nicht aktualisiert werden."
echo "${prefix}${nr}"
